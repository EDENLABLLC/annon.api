language: elixir
cache:
  directories:
    - deps
    - _build
services:
  - docker
  - cassandra
addons:
  postgresql: "9.5"
elixir:
  - 1.4.2
otp_release:
  - 19.3
env:
  global:
    - MIX_ENV=test
    - DOCKER_HUB_ACCOUNT=nebo15
    - MAIN_BRANCHES="master develop staging" # Branches on which you want version to be incremented
    - RELEASE_BRANCH="master"
    # Docker credentials
    - secure: "X6V59z2UENFNs09wReiGqGB66Z0SYIVH8yU0+uAIZh+O7kxvp+nS9HWOjdpdNGHTvBUAsGQVE7HAJESCt6tpdRltiRM1/EsJRKb9Zf+eiBa01LHxGVTkU5f8fpTPXvXEaf/FHtRSyKn7ANjbNSW518+BY63q2NxCNmHJuG4Aka8fkNJbtC0Ndoe81xp9jhW4GSv/ciacc+a0AABu09KVVIPF/OjioDLjjUhiwxHXC6GLC8SRap3axWEUCBmQ/1nQ1MeQ34KE9IHJ2DSh1bV87uH6CiAgORpGpHkED5v2WFfpePIP8h3ekKk1a4jVjwUAu8Ya126aCsQLKqSPTmaOO3pSXwAYTZeRIf7dr8pE4xTOv+XfPQVq+yzvQHT/XiugH/zOh8RvSqDMPBYLbRqYB+6wETA0zgO12w1AU3+r7GaNuEwMBgvXtIK/ccWac3RpE1RK8jsuiWLrQEVAskzhz41EOBiuZXipiRP9hwcsvqrNUyoD3b2y54WJaaMqzoCEZ9aW3ZZRXzNfHXxxq75bMQyU4tAM4nVPOA8SsioGruwDXgR4SloTrOAPIMvYTFzOwIabwDkIPeYpIqVoIlDs5e7BWftMA1DqhFJnFuXJGxWq+vT56aV85LSZE1Es5U0uv1fY2bX10G2o6mhqChBTVfPqCIk9EXdjChQKZH7DRuU="
    - secure: "loG72FD9OP9zZGgd0kV2KwpmCHbFOqOSRn6ILJkrlilgag5EonNbnt8k0EYPLR7vMvhC/lNrRHWYl5yZUHmq/SI8uCxuQ3y1Hx3uukH8OjQTIHnh3usMdfg/Hdwc4KujsKJWkX3i4l0Dl0WEL8W+yHABD9QvbESWS+WAgQ07V6KRzxzFJb5uBr3rA1fworHaoZzhPFpT3NKU/FqAI/CFgx+ok9iR5IVNP7SsrdFqPbpU0sc3tv5LpquxkFOqS5zscq1KJHYZxvCYhZSzeN/pDCueFBIXJych5wkvYNf+8yHyNiiNUHsznMu8Fcfxmg/kj65T/f2+pmUyja6UUbAgnzHUH+luN72DRB1X6ziGSQb5PyT80Ly5Zx7ntgmNaSCHaxOk0KZGEYjk7Fj1sJ3bQVL+HGj3IG7+Ccz7ChINGMpHsovXKFtWEcsxMAP1jPYVYgaefJK87Fu2vlen46xygaLQBJKkmhRKK5UL8UrjG+bnLTrnf6vRYflBO/BbhaRlb1OmURlUztpTBUXEHJh+IBrRLhS0Bb9jCzC9zvzEdFGka9nZGuOqijdd8gWEfN/s2AQJ3grlT/qrZRjCfjJ+GMlM2+wYjc59uWEPQnci6sgPgCTVzwzKMgi2lWFzxFRhTKUM6XKIAwIrbaVhCTbkkB6fFm92nNtrx/EOIakMyO0="
branches:
  # Releases are generated automatically, stop infinite build loop
  except:
    - /[0-9]*\.[0-9]*\.[0-9]*/
before_install:
  # Expose DB to Docker container
  - sudo /bin/bash ./bin/ci/init-db.sh
before_script:
  - epmd -daemon
script:
  # Increment version in mix.exs
  - ./bin/ci/version-increment.sh
  # Install dependencies
  # - mix deps.get
  # Run all tests except pending ones
  - mix test --exclude pending --trace
  # Submit code coverage report to Coveralls
  - mix coveralls.travis --exclude pending
  # Run static code analysis
  - mix credo -a
  # Check code style
  - mix dogma
  # Build Docker container
  - ./bin/build.sh
  # Initialize DB for Docker container
  - source .env; PGPASSWORD="${DB_PASSWORD}"; psql -U ${DB_USER} -w -c"CREATE DATABASE ${DB_NAME}"
  # Run Docker container
  - sudo ./bin/start.sh
  - sleep 5
  - docker ps
  - RUNNING_CONTAINERS=`docker ps | wc -l`;
    if [ "${RUNNING_CONTAINERS//[[:space:]]/}" == "1" ]; then
      echo "[E] Container is not started\!";
      docker logs annon_api --details --since 5h;
      exit 1;
    fi;
  # Run acceptance tests on Docker container
  - ./bin/ci/sanity-test.sh
  # Rebuild docs
  - "mix docs --output docs"
after_failure:
  - docker logs annon_api --details --since 5h
after_success:
  # Submit Docker container to Docker Hub and create GitHub Release by pushing tag with changelog
  - ./bin/ci/push.sh
