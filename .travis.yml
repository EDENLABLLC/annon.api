language: elixir
cache:
  directories:
    - deps
    - _build
services:
  - docker
  - postgresql
addons:
  postgresql: "9.5"
elixir:
  - 1.4.2
otp_release:
  - 19.3
env:
  global:
    - MIX_ENV=test
    - DOCKER_HUB_ACCOUNT=nebo15
    - MAIN_BRANCHES="master develop staging" # Branches on which you want version to be incremented
    - RELEASE_BRANCH="master"
    # Docker credentials
    - secure: "1UEh4uiWSjQDv5xmY2Jl7zHSRVO2N7/Zwps/BdXV7A2VKt7U3vh5PmC/viN/sjoNCTjLXopGxNY05NVSFoPDB3QiTrIjhAMTKfs0UFEL19RqyFD0qVGC4elsYjci9J7XmsswNzvNDdkVJiy7MYxEdMJWEZ5pC18+h1lkZpck0XIKFFthUZ6gSOeH+QW/zSyrhY0lAtuPxyRbOTBK2bmudWv0aprz8JvyViXXPVM9g8m5TxyPEaSXhWCsJiGxARyVK4ErALw7WwPEhrTX/tidCxuO05vSJYsxcOOc7mGNVloETRpQze5dywSBdyKtaNsH9+X6IdC65hIIkVg/hf2PB19VS7jl0X3FyYWDeUdcJyNeUwvfBS0wu72QgldpAteevWN3R9+UxqPkr+KVWfZcO2vmHbZs/BWPeRL/xq3mI3QdwWGyzuxzEAqBLgnIpw33mOiEDrx2gEPuliR0nsylOo5rF//OWNbEZPd2e2m3bVMPjiPAsH9KNO9UqySwyIHFkJIMDZ+7QzFWZWK5cIdoRTylWgz/QuMccEXaId2nEHIc40iMNIaEXBhiWIazl+EnRh5HG6bG78YmRu6EpzrC/SWJcPforFxteRsAJ7clWPSPe41D8ljnc99tTA6oJQGH37Iknb4V/qDeUoYW1DMNrorhERZ0gPzeuuRtI2Hbf9Q="
    - secure: "O23hNI6fg8sII/fPkYKYK3IxSmc2aUSN/ZaITPH2hR777ARe9J7XEgtVBb0kBUZSetkcAXhmT5ZtfFcQzCZ06Jd4INkoTPvZiwdhlM1d3XbZKslxv8PZjaz8OTOTZnqZLaC+DH1mj5oRxbtm8OSKciRp11/hVgl+E5+NSsXdd7TPFhgezKAR6hTDc0M/8s9ESNzsbmpBu+i9a39160CdwzvC2Nyhqrq0sDVDsxORmYnAZsRdTYGAfZfoyjEmfCRoa4/BDAVUmacxtxtQPwZX4z1IfNUZ1z2jgtDGXwfWiK+1q0nyFPFUcPMJBS9CNF6L0O4tc/6h+mlArjHDk4sqGpyeCJWJbBsJDouV2JZ+V4I2irZ5sAfQ6d4Niqwwn0G/PQK05nmZnegZb9mTV6/7K4p4nikPBdRNdrSN+ghh6gCHxG3CkoaRMsvpcl7mqdRUrhDnrnZYGNsv9hwYECu0R4VQKgtFEU9Czbfz0sXi44PwJGnctoIIEla5C2DbTH3aSpSV0pY5xtn1CT6kTrHb3m3g3MrWfNbJpbUVQ24lOOQoA196pLHW6nW0XyXM760ThTzmCbguL/Z4Tp/1KONxijIMc7ixpPHahcGPN+1pCo7QGANvAOeeEJWj3MOvQqcnz1AvyGIAff07m5rdt/hNjkOCMsUcD8viCarD2BIZ0mU="
branches:
  # Releases are generated automatically, stop infinite build loop
  except:
    - /[0-9]*\.[0-9]*\.[0-9]*/
before_install:
  # Expose DB to Docker container
  - sudo /bin/bash ./bin/ci/init-db.sh
before_script:
  - epmd -daemon
script:
  # Increment version in mix.exs
  - ./bin/ci/version-increment.sh
  # Install dependencies
  # - mix deps.get
  # Run all tests except pending ones
  - mix test --exclude pending --trace
  # Submit code coverage report to Coveralls
  - mix coveralls.travis --exclude pending
  # Run static code analysis
  - mix credo -a
  # Check code style
  - mix dogma
  # Build Docker container
  - ./bin/build.sh
  # Initialize DB for Docker container
  - source .env; PGPASSWORD="${DB_PASSWORD}"; psql -U ${DB_USER} -w -c"CREATE DATABASE ${DB_NAME}"
  # Run Docker container
  - sudo ./bin/start.sh
  - sleep 5
  - docker ps
  - RUNNING_CONTAINERS=`docker ps | wc -l`;
    if [ "${RUNNING_CONTAINERS//[[:space:]]/}" == "1" ]; then
      echo "[E] Container is not started\!";
      docker logs annon_api --details --since 5h;
      exit 1;
    fi;
  # Run acceptance tests on Docker container
  - ./bin/ci/sanity-test.sh
  # Rebuild docs
  - "mix docs --output docs"
after_failure:
  - docker logs annon_api --details --since 5h
after_success:
  # Submit Docker container to Docker Hub and create GitHub Release by pushing tag with changelog
  - ./bin/ci/push.sh
